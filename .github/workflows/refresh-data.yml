name: Refresh dashboard data

on:
  schedule:
    - cron: "0 6 * * 1"
  workflow_dispatch:

jobs:
  refresh:
    runs-on: ubuntu-latest
    permissions:
      contents: write   # nécessaire pour git push

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install pandas requests

      # ✅ Résout les variables d'env avec fallback:
      # 1) vars.* (Variables) -> 2) secrets.* (Secrets) -> 3) valeur par défaut (server)
      - name: Resolve Kobo env (with fallback)
        shell: bash
        run: |
          # KOBO_SERVER_URL (default: ee)
          if [ -n "${{ vars.KOBO_SERVER_URL }}" ]; then
            echo "KOBO_SERVER_URL=${{ vars.KOBO_SERVER_URL }}" >> $GITHUB_ENV
          elif [ -n "${{ secrets.KOBO_SERVER_URL }}" ]; then
            echo "KOBO_SERVER_URL=${{ secrets.KOBO_SERVER_URL }}" >> $GITHUB_ENV
          else
            echo "KOBO_SERVER_URL=https://ee.kobotoolbox.org" >> $GITHUB_ENV
          fi

          # KOBO_ASSET_ID (must exist either as variable or secret)
          if [ -n "${{ vars.KOBO_ASSET_ID }}" ]; then
            echo "KOBO_ASSET_ID=${{ vars.KOBO_ASSET_ID }}" >> $GITHUB_ENV
          elif [ -n "${{ secrets.KOBO_ASSET_ID }}" ]; then
            echo "KOBO_ASSET_ID=${{ secrets.KOBO_ASSET_ID }}" >> $GITHUB_ENV
          fi

          # KOBO_API_TOKEN (must exist as secret ideally)
          if [ -n "${{ secrets.KOBO_API_TOKEN }}" ]; then
            echo "KOBO_API_TOKEN=${{ secrets.KOBO_API_TOKEN }}" >> $GITHUB_ENV
          fi

      # ✅ Debug SAFE: affiche seulement OK/MISSING (pas de valeurs)
      - name: Debug env presence (safe)
        shell: bash
        run: |
          test -n "$KOBO_SERVER_URL" && echo "KOBO_SERVER_URL: OK" || echo "KOBO_SERVER_URL: MISSING"
          test -n "$KOBO_ASSET_ID" && echo "KOBO_ASSET_ID: OK" || echo "KOBO_ASSET_ID: MISSING"
          test -n "$KOBO_API_TOKEN" && echo "KOBO_API_TOKEN: OK" || echo "KOBO_API_TOKEN: MISSING"
          if [ -z "$KOBO_ASSET_ID" ] || [ -z "$KOBO_API_TOKEN" ]; then
            echo "ERROR: KOBO_ASSET_ID and KOBO_API_TOKEN are required."
            exit 1
          fi

      - name: Pull Kobo CSV
        run: python scripts/01_fetch_kobo_csv.py

      - name: Quick check
        run: python scripts/03_quick_check.py

      - name: Build JSON
        run: python scripts/02_build_json.py

      - name: Commit and push (if changes)
        shell: bash
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add data/*.json data/raw/submissions.csv

          if git diff --cached --quiet; then
            echo "No changes."
            exit 0
          fi

          git commit -m "chore: refresh dashboard data"
          git push
